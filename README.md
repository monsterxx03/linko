# Linko - ç½‘ç»œä»£ç†å’Œæµé‡åˆ†æå·¥å…·

Linko æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ç½‘ç»œä»£ç†æœåŠ¡å™¨ï¼Œå…·æœ‰DNSåˆ†æµã€æµé‡åˆ†æå’Œå¤šåè®®æ”¯æŒåŠŸèƒ½ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- **é€æ˜ä»£ç†**ï¼šæ”¯æŒTCPæµé‡è½¬å‘å’ŒDNS UDP 53ç«¯å£é€æ˜ä»£ç†
- **DNSåˆ†æµ**ï¼šåŸºäºIPåœ°ç†ä½ç½®çš„æ™ºèƒ½DNSè§£æï¼ˆå›½å†…/å›½å¤–åˆ†æµï¼‰
- **å¤šåè®®æ”¯æŒ**ï¼šSOCKS5ã€HTTP CONNECTéš§é“
- **æµé‡åˆ†æ**ï¼šå®æ—¶DNSæŸ¥è¯¢ç»Ÿè®¡å’Œå†å²æ•°æ®åˆ†æ (SQLiteå­˜å‚¨)
- **SNIæå–**ï¼šä»HTTPSæ¡æ‰‹åŒ…ä¸­æå–ä¸»æœºä¿¡æ¯
- **ç®¡ç†API**ï¼šæä¾›HTTP APIæŸ¥çœ‹DNSç»Ÿè®¡å’Œç³»ç»ŸçŠ¶æ€

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

- Go 1.25+
- macOS æˆ– Linux
- ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äºé…ç½®é˜²ç«å¢™è§„åˆ™ï¼‰

### å®‰è£…

1. å…‹éš†é¡¹ç›®ï¼š
```bash
git clone https://github.com/monsterxx03/linko.git
cd linko
```

2. å®‰è£…ä¾èµ–ï¼š
```bash
make deps
```

3. ç”Ÿæˆé»˜è®¤é…ç½®ï¼š
```bash
make config
```

5. æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼š
```bash
make build
```

### è¿è¡Œ

```bash
./bin/linko -c config/linko.yaml
```

### å¼€å‘æ¨¡å¼

```bash
make run
```

## ğŸ“‹ é…ç½®è¯´æ˜

è¯¦ç»†é…ç½®é€‰é¡¹è¯·å‚è€ƒ `config/linko.yaml`ï¼š

### æ ¸å¿ƒé…ç½®

```yaml
server:
  listen_addr: 127.0.0.1:9890   # ä»£ç†æœåŠ¡ç›‘å¬åœ°å€
  log_level: info                # æ—¥å¿—çº§åˆ«

dns:
  listen_addr: 127.0.0.1:6363    # DNSæœåŠ¡å™¨ç›‘å¬åœ°å€
  domestic_dns:                  # å›½å†…DNSæœåŠ¡å™¨
    - 223.5.5.5
    - 114.114.114.114
  foreign_dns:                   # å›½å¤–DNSæœåŠ¡å™¨
    - 8.8.8.8
    - 1.1.1.1
  ipdb_path: data/geoip.mmdb     # GeoIPæ•°æ®åº“è·¯å¾„
  cache_ttl: 5m                  # DNSç¼“å­˜TTL
  tcp_for_foreign: true          # å›½å¤–DNSä½¿ç”¨TCP

upstream:
  enable: true                   # å¯ç”¨ä¸Šæ¸¸ä»£ç†
  type: socks5                   # ä¸Šæ¸¸ç±»å‹ (socks5/http)
  addr: 127.0.0.1:7891           # ä¸Šæ¸¸åœ°å€

admin:
  enable: true                   # å¯ç”¨ç®¡ç†æœåŠ¡å™¨
  listen_addr: 0.0.0.0:9810     # ç®¡ç†APIç›‘å¬åœ°å€

firewall:
  enable_auto: true              # è‡ªåŠ¨é…ç½®é˜²ç«å¢™
  redirect_dns: true             # é‡å®šå‘DNS
  redirect_http: true            # é‡å®šå‘HTTP
  redirect_https: true           # é‡å®šå‘HTTPS
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š
```bash
make test
```

è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼š
```bash
make test-coverage
```

## ğŸ“Š é¡¹ç›®æ¶æ„

```
linko/
â”œâ”€â”€ cmd/linko/          # CLI å…¥å£
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ admin/          # ç®¡ç†æœåŠ¡å™¨ (HTTP API)
â”‚   â”œâ”€â”€ config/         # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ dns/            # DNS æœåŠ¡å™¨å’Œåˆ†æµ
â”‚   â”œâ”€â”€ ipdb/           # ä¸­å›½IPæ£€æµ‹ (APNIC + cidranger)
â”‚   â””â”€â”€ proxy/          # é€æ˜ä»£ç†å’Œé˜²ç«å¢™é…ç½®
â”œâ”€â”€ config/             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/               # æµé‡æ•°æ®åº“
â””â”€â”€ Makefile            # æ„å»ºè„šæœ¬
```

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Linko Server                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DNS Server â”‚  â”‚   Proxy     â”‚  â”‚    Admin Server     â”‚  â”‚
â”‚  â”‚  (UDP/TCP)  â”‚  â”‚ Transparent â”‚  â”‚   (HTTP API)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                     â”‚              â”‚
â”‚         â–¼                â–¼                     â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ DNS Splitterâ”‚  â”‚  Upstream    â”‚  â”‚   Stats Collector   â”‚  â”‚
â”‚  â”‚ + Cache     â”‚  â”‚  SOCKS5/HTTP â”‚  â”‚   (DNS + Traffic)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚              China IP Database (APNIC + cidranger)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ºï¸ å¼€å‘è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„å’ŒDNSåˆ†æµ âœ…
- [x] é¡¹ç›®ç»“æ„è®¾è®¡
- [x] ä¸­å›½IPæ•°æ®åº“é›†æˆ (APNIC + cidranger)
- [x] DNSåˆ†æµå™¨å®ç°
- [x] åŸºç¡€é…ç½®ç®¡ç†
- [x] DNSæœåŠ¡å™¨(UDP/TCP)
- [x] DNSç¼“å­˜æœºåˆ¶

### Phase 2: æ ¸å¿ƒä»£ç†å±‚ âœ…
- [x] SOCKS5åè®®å®ç°
- [x] é€æ˜ä»£ç†æ ¸å¿ƒé€»è¾‘
- [x] è¿æ¥æ± å’Œè¿æ¥ç®¡ç†
- [x] é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶
- [x] macOS/Linuxé˜²ç«å¢™é…ç½®
- [x] æµé‡é™æµå’Œç®¡ç†

### Phase 3: æµé‡åˆ†æå’Œç»Ÿè®¡ âœ…
- [x] SNIä¿¡æ¯æå–
- [x] å®æ—¶æµé‡ç»Ÿè®¡
- [x] å†å²æ•°æ®å­˜å‚¨ (SQLite)
- [x] Webç®¡ç†ç•Œé¢ (Admin API)

### Phase 4: åè®®æ‰©å±•å’Œä¼˜åŒ–
- [x] HTTP CONNECTéš§é“
- [ ] æ€§èƒ½è°ƒä¼˜
- [ ] å®Œæ•´æµ‹è¯•å’Œæ–‡æ¡£

## ğŸ”§ å¼€å‘å·¥å…·

å®‰è£…å¼€å‘ä¾èµ–ï¼š
```bash
make dev-deps
```

æ ¼å¼åŒ–ä»£ç ï¼š
```bash
make fmt
```

ä»£ç æ£€æŸ¥ï¼š
```bash
make lint
```

## ğŸ“¦ æ„å»º

### æœ¬åœ°æ„å»º
```bash
make build
```

### Linuxæ„å»º
```bash
make build-linux
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### åŸºç¡€ä½¿ç”¨

#### å¯åŠ¨æœåŠ¡å™¨
```bash
# å¯åŠ¨DNSå’ŒSOCKS5ä»£ç†æœåŠ¡å™¨
./bin/linko -c config/linko.yaml

# å¯ç”¨è‡ªåŠ¨é˜²ç«å¢™é…ç½® (éœ€è¦sudoæƒé™)
sudo ./bin/linko --firewall -c config/linko.yaml
```

#### å®¢æˆ·ç«¯é…ç½®

**SOCKS5ä»£ç†**
- ä¸»æœº: 127.0.0.1
- ç«¯å£: 9890

**HTTPä»£ç†**
- ä¸»æœº: 127.0.0.1
- ç«¯å£: 9890

**DNSé…ç½®**
- ä¸»DNS: 127.0.0.1:6363

**ç®¡ç†API**
- åœ°å€: http://127.0.0.1:9810

### é€æ˜ä»£ç†é…ç½®

#### è‡ªåŠ¨é…ç½® (æ¨è)
Linkoæ”¯æŒè‡ªåŠ¨é…ç½®é˜²ç«å¢™è§„åˆ™ï¼š

```bash
# å¯ç”¨è‡ªåŠ¨é˜²ç«å¢™é…ç½®
sudo ./bin/linko --firewall
```

æˆ–è€…åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š
```yaml
firewall:
  enable_auto: true
  proxy_port: "9890"
  redirect_dns: true
  redirect_http: true
  redirect_https: true
```

**æ³¨æ„**: è‡ªåŠ¨é…ç½®éœ€è¦sudo/rootæƒé™ï¼Œä¼šè‡ªåŠ¨è®¾ç½®ä»¥ä¸‹è§„åˆ™ï¼š
- DNS (53) â†’ 6363
- HTTP (80) â†’ 9890
- HTTPS (443) â†’ 9890

#### æ‰‹åŠ¨é…ç½®

##### macOS
```bash
# ä½¿ç”¨pfctlé…ç½®è§„åˆ™
sudo pfctl -f pf.conf
```

##### Linux
```bash
# ä½¿ç”¨iptablesé…ç½®è§„åˆ™
sudo iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-port 9890
sudo iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 9890
```

### DNSé…ç½®

å°†ç³»ç»ŸDNSè®¾ç½®ä¸ºï¼š
```
127.0.0.1:6363
```

### ç®¡ç†API

ç®¡ç†æœåŠ¡å™¨é»˜è®¤ç›‘å¬ `0.0.0.0:9810`ï¼Œæä¾›ä»¥ä¸‹APIç«¯ç‚¹ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/health` | GET | å¥åº·æ£€æŸ¥ |
| `/stats/dns` | GET | DNSæŸ¥è¯¢ç»Ÿè®¡ |
| `/stats/dns/clear` | POST | æ¸…ç©ºDNSç»Ÿè®¡ |
| `/cache/dns/clear` | POST | æ¸…é™¤DNSç¼“å­˜ |

#### APIå“åº”ç¤ºä¾‹

```json
// GET /stats/dns
{
  "code": 0,
  "message": "success",
  "data": {
    "total_queries": 12345,
    "cache": {
      "size": 456,
      "hit_rate": 0.85
    },
    "queries_by_type": {
      "A": 8000,
      "AAAA": 3000,
      "CNAME": 1000,
      "OTHER": 345
    },
    "queries_by_source": {
      "domestic": 9000,
      "foreign": 3345
    }
  }
}
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Pull Requestå’ŒIssueï¼

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…

## ğŸ™ è‡´è°¢

- [miekg/dns](https://github.com/miekg/dns) - Goè¯­è¨€DNSåº“
- [cidranger](https://github.com/yl2chen/cidranger) - é«˜æ€§èƒ½IPæ®µåŒ¹é…
- [APNIC](https://www.apnic.net/) - ä¸­å›½IPåœ°å€æ•°æ®æ¥æº

## âš ï¸ æ³¨æ„äº‹é¡¹

1. éœ€è¦ç®¡ç†å‘˜æƒé™è¿è¡Œï¼ˆç”¨äºé…ç½®é˜²ç«å¢™è§„åˆ™ï¼‰
2. ä¸­å›½IPåœ°å€æ•°æ®é€šè¿‡ APNIC è‡ªåŠ¨æ›´æ–°
3. åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·å……åˆ†æµ‹è¯•
4. é€æ˜ä»£ç†åŠŸèƒ½éœ€è¦ç³»ç»Ÿçº§é…ç½®

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ [Issue](https://github.com/monsterxx03/linko/issues)